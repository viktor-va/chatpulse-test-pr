services:
  nginx:
    image: nginx:1.27-alpine
    container_name: chatpulse_nginx
    ports:
      - "8080:80"
    depends_on:
      - php
    volumes:
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/logs:/var/log/nginx
      - ./src:/var/www/html:cached
    networks: [appnet]

  php:
    build:
      context: ./docker/php
    container_name: chatpulse_php
    environment:
      PHP_MEMORY_LIMIT: 512M
    volumes:
      - ./src:/var/www/html:cached
    networks: [appnet]

  postgres:
    image: postgres:16-alpine
    container_name: chatpulse_pg
    environment:
      POSTGRES_DB: chatpulse
      POSTGRES_USER: chatpulse
      POSTGRES_PASSWORD: chatpulse
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks: [appnet]

  redis:
    image: redis:7-alpine
    container_name: chatpulse_redis
    ports:
      - "6379:6379"
    networks: [appnet]

  queue-worker:
    build:
      context: ./docker/php
    container_name: chatpulse_queue
    depends_on: [redis, postgres, php]
    working_dir: /var/www/html
    command: php artisan queue:work --verbose --tries=3 --timeout=90
    volumes:
      - ./src:/var/www/html:cached
    networks: [appnet]

  reverb:
    build:
      context: ./docker/php
    container_name: chatpulse_reverb
    depends_on: [redis, php]
    working_dir: /var/www/html
    environment:
      REVERB_SERVER_HOST: 0.0.0.0
      REVERB_SERVER_PORT: 8081
    command: php artisan reverb:start --host=0.0.0.0 --port=8081
    ports:
      - "8081:8081"
    volumes:
      - ./src:/var/www/html:cached
    networks: [appnet]


    # docker-compose.yml
  prometheus:
    image: prom/prometheus:v2.54.0
    container_name: chatpulse_prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    volumes:
      - ./docker/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./docker/monitoring/rules.yml:/etc/prometheus/rules.yml:ro
    ports:
      - "9090:9090"
    depends_on: [ nginx ]
    networks: [ appnet ]

  grafana:
    image: grafana/grafana:11.1.0
    container_name: chatpulse_grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"
    depends_on: [ prometheus ]
    networks: [ appnet ]

  redis_exporter:
    image: oliver006/redis_exporter:v1.62.0
    container_name: chatpulse_redis_exporter
    environment:
      - REDIS_ADDR=redis:6379
      # If you add a password:
      # - REDIS_PASSWORD=yourpassword
    ports:
      - "9121:9121"   # optional to expose on host; Prometheus can reach it via network
    depends_on: [ redis ]
    networks: [ appnet ]

  postgres_exporter:
    image: quay.io/prometheuscommunity/postgres-exporter:v0.15.0
    container_name: chatpulse_postgres_exporter
    environment:
      - DATA_SOURCE_NAME=postgresql://chatpulse:chatpulse@postgres:5432/chatpulse?sslmode=disable
    ports:
      - "9187:9187"  # optional for host access
    depends_on: [ postgres ]
    networks: [ appnet ]

  elastic:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.3
    container_name: chatpulse_elastic
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    networks: [ appnet ]

  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.3
    container_name: chatpulse_kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elastic:9200
    depends_on: [ elastic ]
    ports:
      - "5601:5601"
    networks: [ appnet ]

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.14.3
    container_name: chatpulse_filebeat
    user: root
    volumes:
      - ./docker/monitoring/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./docker/nginx/logs:/var/log/nginx:ro
      - ./src/storage/logs:/var/www/html/storage/logs:ro
    depends_on: [ elastic ]
    networks: [ appnet ]


networks:
  appnet:

volumes:
  pgdata:

